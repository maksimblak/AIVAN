"""
UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è Telegram –±–æ—Ç–∞ –ò–ò-–ò–≤–∞–Ω
–°–æ–¥–µ—Ä–∂–∏—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, —ç–º–æ–¥–∑–∏, —à–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
"""

from __future__ import annotations

# ============ –≠–ú–û–î–ó–ò –ö–û–ù–°–¢–ê–ù–¢–´ ============


class Emoji:
    """–ö–æ–ª–ª–µ–∫—Ü–∏—è —ç–º–æ–¥–∑–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""

    # –û—Å–Ω–æ–≤–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ
    ROBOT = "ü§ñ"
    LAW = "‚öñÔ∏è"
    DOCUMENT = "üìã"
    SEARCH = "üîç"
    IDEA = "üí°"
    WARNING = "‚ö†Ô∏è"
    SUCCESS = "‚úÖ"
    ERROR = "‚ùå"
    LOADING = "‚è≥"
    FIRE = "üî•"
    STAR = "‚≠ê"
    MAGIC = "‚ú®"

    # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∞–≤–∞
    CIVIL = "üè†"
    CRIMINAL = "üö®"
    CORPORATE = "üè¢"
    CONTRACT = "üìù"
    LABOR = "üë®‚Äçüíº"
    TAX = "üí∞"
    REAL_ESTATE = "üèòÔ∏è"
    IP = "üíº"
    ADMIN = "üèõÔ∏è"
    FAMILY = "üë™"

    # –ù–∞–≤–∏–≥–∞—Ü–∏—è
    BACK = "‚óÄÔ∏è"
    HOME = "üè†"
    HELP = "‚ùì"
    SETTINGS = "‚öôÔ∏è"
    STATS = "üìä"
    UP = "üî∫"
    DOWN = "üîª"

    # –î–µ–π—Å—Ç–≤–∏—è
    SAVE = "üíæ"
    SHARE = "üì§"
    COPY = "üìÑ"
    PRINT = "üñ®Ô∏è"
    DOWNLOAD = "üì•"

    # –°—Ç–∞—Ç—É—Å—ã
    ONLINE = "üü¢"
    OFFLINE = "üî¥"
    PENDING = "üü°"
    CLOCK = "üïê"
    CALENDAR = "üìÖ"


# ============ –¶–í–ï–¢–û–í–´–ï –°–•–ï–ú–´ ============


class Colors:
    """–¶–≤–µ—Ç–∞ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ Telegram, –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)"""

    PRIMARY = "#2196F3"  # –°–∏–Ω–∏–π
    SUCCESS = "#4CAF50"  # –ó–µ–ª–µ–Ω—ã–π
    WARNING = "#FF9800"  # –û—Ä–∞–Ω–∂–µ–≤—ã–π
    ERROR = "#F44336"  # –ö—Ä–∞—Å–Ω—ã–π
    INFO = "#00BCD4"  # –ì–æ–ª—É–±–æ–π


# ============ –®–ê–ë–õ–û–ù–´ –°–û–û–ë–©–ï–ù–ò–ô (MarkdownV2) ============


class MessageTemplates:
    """–®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∫—Ä–∞—Å–∏–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º (MarkdownV2)"""

    WELCOME = f"""{Emoji.LAW} **–ò–ò\\-–ò–≤–∞–Ω** ‚Äî –≤–∞—à —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç

{Emoji.ROBOT} –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å –Ω–∞ —Ä–æ—Å—Å–∏–π—Å–∫–æ–º –ø—Ä–∞–≤–µ –∏ —Å—É–¥–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–µ
{Emoji.SEARCH} –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–µ–ª–∞, –Ω–∞—Ö–æ–∂—É —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É  
{Emoji.DOCUMENT} –ì–æ—Ç–æ–≤–ª—é —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

{Emoji.WARNING} *–í–∞–∂–Ω–æ*: –≤—Å–µ –æ—Ç–≤–µ—Ç—ã —Ç—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —é—Ä–∏—Å—Ç–æ–º

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"""

    HELP = f"""{Emoji.HELP} **–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é**

{Emoji.MAGIC} **–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**

{Emoji.IDEA} –£–∫–∞–∑—ã–≤–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —é—Ä–∏—Å–¥–∏–∫—Ü–∏—é
{Emoji.CALENDAR} –£–ø–æ–º–∏–Ω–∞–π—Ç–µ –¥–∞—Ç—ã –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
{Emoji.DOCUMENT} –û–ø–∏—Å—ã–≤–∞–π—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞
{Emoji.STAR} –§–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ —á–µ—Ç–∫–∏–π –ø—Ä–∞–≤–æ–≤–æ–π –≤–æ–ø—Ä–æ—Å

{Emoji.LAW} **–ß—Ç–æ —è —É–º–µ—é:**
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Å—É–¥–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏
‚Ä¢ –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–µ–ª
‚Ä¢ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
‚Ä¢ –û—Ü–µ–Ω–∫–∞ –ø—Ä–∞–≤–æ–≤—ã—Ö —Ä–∏—Å–∫–æ–≤
‚Ä¢ –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∞–≤–æ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

{Emoji.WARNING} **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
–ù–µ —Ä–∞–∑–≥–ª–∞—à–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ—Ç—å–∏—Ö –ª–∏—Ü"""

    CATEGORIES = f"""{Emoji.LAW} **–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –ø—Ä–∞–≤–∞**

–í—ã–±–æ—Ä —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç:"""

    PROCESSING_STAGES = [
        f"{Emoji.SEARCH} –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à –≤–æ–ø—Ä–æ—Å...",
        f"{Emoji.LOADING} –ò—â—É —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é —Å—É–¥–µ–±–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É...",
        f"{Emoji.DOCUMENT} –§–æ—Ä–º–∏—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç...",
        f"{Emoji.MAGIC} –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏...",
    ]

    ERROR_GENERIC = f"""{Emoji.ERROR} **–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞**

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å\\.

{Emoji.HELP} *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*
‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É –≤–æ–ø—Ä–æ—Å–∞
‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç
‚Ä¢ –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è"""

    NO_QUESTION = f"""{Emoji.WARNING} **–ü—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å**

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞\\."""


# ============ –ö–ê–¢–ï–ì–û–†–ò–ò –ü–†–ê–í–ê ============

LEGAL_CATEGORIES = {
    "civil": {
        "name": "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–µ –ø—Ä–∞–≤–æ",
        "emoji": Emoji.CIVIL,
        "description": "–ò–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏ –ª–∏—á–Ω—ã–µ –Ω–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è",
        "examples": ["–î–æ–≥–æ–≤–æ—Ä—ã", "–°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", "–û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞", "–î–µ–ª–∏–∫—Ç—ã"],
    },
    "corporate": {
        "name": "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–æ",
        "emoji": Emoji.CORPORATE,
        "description": "–°–æ–∑–¥–∞–Ω–∏–µ –∏ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü",
        "examples": ["–£—á—Ä–µ–∂–¥–µ–Ω–∏–µ –û–û–û", "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Ä—ã", "–†–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è", "M&A"],
    },
    "contract": {
        "name": "–î–æ–≥–æ–≤–æ—Ä–Ω–æ–µ –ø—Ä–∞–≤–æ",
        "emoji": Emoji.CONTRACT,
        "description": "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ, –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–æ–≤",
        "examples": ["–ü–æ—Å—Ç–∞–≤–∫–∞", "–ü–æ–¥—Ä—è–¥", "–ê—Ä–µ–Ω–¥–∞", "–ó–∞–π–º"],
    },
    "labor": {
        "name": "–¢—Ä—É–¥–æ–≤–æ–µ –ø—Ä–∞–≤–æ",
        "emoji": Emoji.LABOR,
        "description": "–¢—Ä—É–¥–æ–≤—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∏ —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞",
        "examples": ["–£–≤–æ–ª—å–Ω–µ–Ω–∏–µ", "–ó–∞—Ä–ø–ª–∞—Ç–∞", "–û—Ç–ø—É—Å–∫–∞", "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞"],
    },
    "tax": {
        "name": "–ù–∞–ª–æ–≥–æ–≤–æ–µ –ø—Ä–∞–≤–æ",
        "emoji": Emoji.TAX,
        "description": "–ù–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏–µ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –§–ù–°",
        "examples": ["–ù–î–°", "–ù–∞–ª–æ–≥ –Ω–∞ –ø—Ä–∏–±—ã–ª—å", "–ù–î–§–õ", "–ü—Ä–æ–≤–µ—Ä–∫–∏"],
    },
    "real_estate": {
        "name": "–ü—Ä–∞–≤–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏",
        "emoji": Emoji.REAL_ESTATE,
        "description": "–°–¥–µ–ª–∫–∏ —Å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å—é –∏ –∑–µ–º–µ–ª—å–Ω—ã–º–∏ —É—á–∞—Å—Ç–∫–∞–º–∏",
        "examples": ["–ö—É–ø–ª—è-–ø—Ä–æ–¥–∞–∂–∞", "–ê—Ä–µ–Ω–¥–∞", "–ò–ø–æ—Ç–µ–∫–∞", "–ö–∞–¥–∞—Å—Ç—Ä"],
    },
    "ip": {
        "name": "–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å",
        "emoji": Emoji.IP,
        "description": "–ê–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–∞–≤–∞, —Ç–æ–≤–∞—Ä–Ω—ã–µ –∑–Ω–∞–∫–∏, –ø–∞—Ç–µ–Ω—Ç—ã",
        "examples": ["–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¢–ó", "–ê–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–∞–≤–∞", "–ü–∞—Ç–µ–Ω—Ç—ã", "–õ–∏—Ü–µ–Ω–∑–∏–∏"],
    },
    "admin": {
        "name": "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–æ",
        "emoji": Emoji.ADMIN,
        "description": "–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –≥–æ—Å–æ—Ä–≥–∞–Ω–∞–º–∏ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å",
        "examples": ["–õ–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ", "–®—Ç—Ä–∞—Ñ—ã", "–ì–æ—Å—É—Å–ª—É–≥–∏", "–ö–æ–Ω—Ç—Ä–æ–ª—å"],
    },
    "criminal": {
        "name": "–£–≥–æ–ª–æ–≤–Ω–æ–µ –ø—Ä–∞–≤–æ",
        "emoji": Emoji.CRIMINAL,
        "description": "–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è –∏ —É–≥–æ–ª–æ–≤–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å",
        "examples": ["–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è", "–î–æ–ª–∂–Ω–æ—Å—Ç–Ω—ã–µ", "–ù–∞–ª–æ–≥–æ–≤—ã–µ", "–ó–∞—â–∏—Ç–∞"],
    },
    "family": {
        "name": "–°–µ–º–µ–π–Ω–æ–µ –ø—Ä–∞–≤–æ",
        "emoji": Emoji.FAMILY,
        "description": "–ë—Ä–∞–∫, —Ä–∞–∑–≤–æ–¥, –∞–ª–∏–º–µ–Ω—Ç—ã, –æ–ø–µ–∫–∞",
        "examples": ["–†–∞–∑–≤–æ–¥", "–ê–ª–∏–º–µ–Ω—Ç—ã", "–†–∞–∑–¥–µ–ª –∏–º—É—â–µ—Å—Ç–≤–∞", "–û–ø–µ–∫–∞"],
    },
}


def get_category_info(category_id: str) -> dict:
    """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∞–≤–∞"""
    return LEGAL_CATEGORIES.get(
        category_id,
        {
            "name": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è",
            "emoji": Emoji.LAW,
            "description": "–û–±—â–∏–µ –ø—Ä–∞–≤–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã",
            "examples": [],
        },
    )


# ============ –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï (MarkdownV2) ============


def escape_markdown_v2(text: str) -> str:
    """–≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è MarkdownV2"""
    special_chars = [
        "_",
        "*",
        "[",
        "]",
        "(",
        ")",
        "~",
        "`",
        ">",
        "#",
        "+",
        "-",
        "=",
        "|",
        "{",
        "}",
        ".",
        "!",
    ]
    for char in special_chars:
        text = text.replace(char, f"\\{char}")
    return text


def format_legal_response(text: str, category: str | None = None) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å –∫—Ä–∞—Å–∏–≤–æ–π —Ä–∞–∑–º–µ—Ç–∫–æ–π MarkdownV2"""
    if category:
        category_info = get_category_info(category)
        header = f"{category_info['emoji']} **{escape_markdown_v2(category_info['name'])}**\n\n"
        text = header + text
    return text


def create_progress_message(stage: int, total: int = 4) -> str:
    """–°–æ–∑–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º (MarkdownV2)"""
    if stage >= len(MessageTemplates.PROCESSING_STAGES):
        stage = len(MessageTemplates.PROCESSING_STAGES) - 1
    progress_bar = "‚ñì" * stage + "‚ñë" * (total - stage)
    percentage = int((stage / total) * 100)
    return f"{MessageTemplates.PROCESSING_STAGES[stage]}\n\n`{progress_bar}` {percentage}%"


def create_progress_message_html(stage: int, total: int = 4) -> str:
    """–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –¥–ª—è HTML-—Ä–µ–∂–∏–º–∞ (–µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ parse_mode=HTML)"""
    if stage >= len(MessageTemplates.PROCESSING_STAGES):
        stage = len(MessageTemplates.PROCESSING_STAGES) - 1
    progress_bar = "‚ñì" * stage + "‚ñë" * (total - stage)
    percentage = int((stage / total) * 100)
    return f"{MessageTemplates.PROCESSING_STAGES[stage]}<br><br><code>{progress_bar}</code> {percentage}%"


# ============ HTML –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –î–õ–Ø STREAMING ============

import re
from html import escape as html_escape

# --- Telegram HTML sanitizer (allowlist) ---
ALLOWED_TAGS = {"b", "i", "u", "s", "code", "pre", "a", "br"}


def sanitize_telegram_html(html: str) -> str:
    """
    –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ç–µ–≥–∏: b,i,u,s,code,pre,a(href=http/https),br.
    –£ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–µ–≥–æ–≤ ‚Äî —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —É–≥–ª–æ–≤—ã–µ —Å–∫–æ–±–∫–∏.
    –£ <a> –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π href, –ø—Ä–æ—á–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã –≤—ã–∫–∏–¥—ã–≤–∞–µ—Ç.
    """
    if not html:
        return ""

    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —É–≥–ª–æ–≤—ã–µ —Å–∫–æ–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ—Ö–æ–∂–∏ –Ω–∞ —Ç–µ–≥, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Ç–µ–∫—Å—Ç —Ç–∏–ø–∞ "a < b"
    html = re.sub(r"<(?!/?[a-zA-Z])", "&lt;", html)

    tag_re = re.compile(r"</?([a-zA-Z0-9]+)(\s[^>]*)?>", re.IGNORECASE)

    def _clean_tag(match: re.Match) -> str:
        full = match.group(0)
        name = (match.group(1) or "").lower()
        attrs = match.group(2) or ""
        is_closing = full.startswith("</")

        # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ç–µ–≥–∏ ‚Äî —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é
        if name not in ALLOWED_TAGS:
            return html_escape(full)

        # <br> –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –∞—Ç—Ä–∏–±—É—Ç–æ–≤; –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–≥–æ –Ω–µ—Ç
        if name == "br":
            return "" if is_closing else "<br>"

        # –ó–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Ç–µ–≥–∏
        if is_closing:
            return f"</{name}>"

        # –û—Ç–∫—Ä—ã–≤–∞—é—â–∏–µ –ø—Ä–æ—Å—Ç—ã–µ —Ç–µ–≥–∏ –±–µ–∑ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ (–∫—Ä–æ–º–µ <a>)
        if name in {"b", "i", "u", "s", "code", "pre"}:
            return f"<{name}>"

        # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ <a ...>
        if name == "a":
            href = ""
            if attrs:
                # href="..." –∏–ª–∏ href='...'
                m = re.search(r'href\s*=\s*"(.*?)"', attrs, re.IGNORECASE)
                if not m:
                    m = re.search(r"href\s*=\s*'([^']*)'", attrs, re.IGNORECASE)
                if m:
                    cand = (m.group(1) or "").strip()
                    if cand.lower().startswith(("http://", "https://")):
                        href = html_escape(cand, quote=True)
            # –µ—Å–ª–∏ href –≤–∞–ª–∏–¥–Ω—ã–π ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É; –∏–Ω–∞—á–µ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª —Ç–µ–≥–∞
            return f'<a href="{href}">' if href else html_escape(full)

        # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        return html_escape(full)

    return tag_re.sub(_clean_tag, html)


def _md_links_to_anchors(line: str) -> str:
    """Convert markdown links [text](url) into safe HTML anchors.

    Both link text and URL are escaped; only http/https URLs are allowed.
    """
    pattern = re.compile(r"\[([^\]]+)\]\((https?://[^\s)]+)\)")
    result_parts: list[str] = []
    last = 0
    for m in pattern.finditer(line):
        # escape non-link part
        result_parts.append(html_escape(line[last : m.start()]))
        text = html_escape(m.group(1))
        url = html_escape(m.group(2), quote=True)
        result_parts.append(f'<a href="{url}">{text}</a>')
        last = m.end()
    # tail
    result_parts.append(html_escape(line[last:]))
    return "".join(result_parts)


def render_legal_html(raw: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç ¬´—Å—ã—Ä–æ–π¬ª –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ –≤ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π HTML –¥–ª—è Telegram.

    –î–µ–ª–∞–µ—Ç:
    - –í—Å—Ç–∞–≤–ª—è–µ—Ç –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å–ª–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (—Å —É—á—ë—Ç–æ–º —Å–∫–æ–±–æ–∫, –Ω–∞–ø—Ä. '–ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç(–ò—Ç–æ–≥–æ)')
    - –°—Ç–∞–≤–∏—Ç –ø—Ä–æ–±–µ–ª –ø–æ—Å–ª–µ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ (2)–¢–µ–∫—Å—Ç -> 2) –¢–µ–∫—Å—Ç)
    - –†–∞–∑—Ä—ã–≤–∞–µ—Ç –∞–±–∑–∞—Ü—ã –ø–µ—Ä–µ–¥ –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π –∏ —Å–ª—É–∂–µ–±–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
    - –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç [—Ç–µ–∫—Å—Ç](url) –≤ <a href="...">—Ç–µ–∫—Å—Ç</a>
    - –î–µ–ª–∞–µ—Ç –∂–∏—Ä–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –∫–æ—Ä–æ—Ç–∫–∏–µ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–π—Ç–ª—ã
    - –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –º–∞—Ä–∫–µ—Ä—ã —Å–ø–∏—Å–∫–æ–≤ (‚Ä¢/‚Äî/- ‚Üí ¬´‚Äî ¬ª)
    - –°–∞–Ω–∏—Ç–∏–∑–∏—Ä—É–µ—Ç HTML –ø–æ–¥ Telegram (b,i,u,s,code,pre,a,br)
    """
    if not raw:
        return ""

    # –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –¥–æ–ø—É—Å—Ç–∏–º—ã–µ HTML-—Ç–µ–≥–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–∞–Ω–∏—Ç–∏–∑–∏—Ä—É–µ–º
    if "<" in raw and re.search(r"<\s*(?:b|i|u|s|code|pre|a|br)\b", raw, re.IGNORECASE):
        return sanitize_telegram_html(raw)

    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
    text = raw.replace("\r\n", "\n").replace("\r", "\n")

    # 0) –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–∏–º –ø—Ä–æ–±–µ–ª –ø–æ—Å–ª–µ –Ω—É–º–µ—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç: "2)–¢–µ–∫—Å—Ç" -> "2) –¢–µ–∫—Å—Ç"
    text = re.sub(r"(^|\n)(\d+[\.)])(?=\S)", r"\1\2 ", text)

    # 1) –í—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –ü–û–°–õ–ï –∫–æ—Ä–æ—Ç–∫–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–≤–∫–ª—é—á–∞—è –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫–æ–±–∫–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ñ—Ä–∞–∑—ã)
    #    –ü—Ä–∏–º–µ—Ä—ã: "1) –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç(–ò—Ç–æ–≥–æ)", "2) –ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä —Å–∏—Ç—É–∞—Ü–∏–∏", "3) –ü—Ä–∏–º–µ—Ä—ã –∏–∑ —Å—É–¥–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏"
    short_header_re = re.compile(
        r"""
        (^|\n)                                   # —Å—Ç–∞—Ä—Ç —Å—Ç—Ä–æ–∫–∏/–∞–±–∑–∞—Ü–∞
        (?:\d+\s*[\.)]\s*)?                      # –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –Ω—É–º–µ—Ä–∞—Ü–∏—è "1) " –∏–ª–∏ "2. "
        (?P<title>                               # —Å–∞–º–∞ —Ñ—Ä–∞–∑–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            –ö—Ä–∞—Ç–∫–∏–π\ –æ—Ç–≤–µ—Ç
            |–ü–æ–¥—Ä–æ–±–Ω—ã–π\ —Ä–∞–∑–±–æ—Ä(?:\s*—Å–∏—Ç—É–∞—Ü–∏–∏)?  # "–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä" (+ –Ω–µ–æ–±—è–∑. "—Å–∏—Ç—É–∞—Ü–∏–∏")
            |–ü—Ä–∏–º–µ—Ä—ã\ –∏–∑\ —Å—É–¥–µ–±–Ω–æ–π\ –ø—Ä–∞–∫—Ç–∏–∫–∏
        )
        (?P<paren>\s*\([^)\n]{0,40}\))?          # –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Å–∫–æ–±–æ—á–Ω–∞—è –ø—Ä–∏–ø–∏—Å–∫–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞, –Ω–∞–ø—Ä. "(–ò—Ç–æ–≥–æ)"
        \s*(?=\S)                                # –∏ –¥–∞–ª—å—à–µ —Å—Ä–∞–∑—É –∏–¥—ë—Ç —Ç–µ–∫—Å—Ç –±–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å–∞ ‚Äî –∑–Ω–∞—á–∏—Ç, –Ω–∞–¥–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Ä–∞–∑—Ä—ã–≤
        """,
        re.IGNORECASE | re.VERBOSE,
    )
    text = short_header_re.sub(lambda m: f"{m.group(1)}{m.group(0).strip()}\n\n", text)

    # 2) –ü–∞—É–∑—ã –ø–µ—Ä–µ–¥ –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π (1) 2) 1. 2.)
    text = re.sub(r"(?<!\n)(?=\b\d+[\.)]\s+)", "\n\n", text)

    # 3) –ü–∞—É–∑—ã –ø–µ—Ä–µ–¥ —Å–ª—É–∂–µ–±–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ (TL;DR, –ö–æ—Ä–æ—Ç–∫–æ, –ò—Ç–æ–≥–∏, –†–µ–∑—é–º–µ, –ü–ª–∞–Ω, –ß—Ç–æ –¥–µ–ª–∞—Ç—å‚Ä¶)
    text = re.sub(
        r"(?<!\n)(?=\b(?:TL;DR|–¢–õ;–î–†|–ö–æ—Ä–æ—Ç–∫–æ|–ò—Ç–æ–≥–∏|–†–µ–∑—é–º–µ|–ü–ª–∞–Ω|–ß—Ç–æ –¥–µ–ª–∞—Ç—å|–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä|–ü—Ä–∏–º–µ—Ä—ã –∏–∑ —Å—É–¥–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏)\b)",
        "\n\n",
        text,
        flags=re.IGNORECASE,
    )

    lines = text.split("\n")
    out: list[str] = []
    prev_empty = False

    for line in lines:
        stripped = line.strip()
        if not stripped:
            if not prev_empty:
                out.append("")
                prev_empty = True
            continue
        prev_empty = False

        # –°—Å—ã–ª–∫–∏ [text](url) -> <a>
        html_line = _md_links_to_anchors(stripped)

        # –ú–∞—Ä–∫–µ—Ä—ã —Å–ø–∏—Å–∫–∞ ‚Ä¢/‚Äî/- ‚Üí ¬´‚Äî ¬ª (–µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –º–∞—Ä–∫–µ—Ä–∞)
        if re.match(r"^\s*(?:‚Ä¢|‚Äî|-)\s+", stripped):
            html_line = re.sub(r"^\s*(?:‚Ä¢|‚Äî|-)\s*", "‚Äî ", html_line)
            out.append(html_line)
            continue

        # –ó–∞–≥–æ–ª–æ–≤–∫–∏
        is_heading = (
            stripped.endswith(":")
            or re.match(r"^(?:tl;dr|—Ç–ª;–¥—Ä|–∫–æ—Ä–æ—Ç–∫–æ|–∏—Ç–æ–≥–∏|—Ä–µ–∑—é–º–µ|–ø–ª–∞–Ω|—á—Ç–æ –¥–µ–ª–∞—Ç—å)\b", stripped, re.IGNORECASE)
        )
        is_numbered = re.match(r"^\d+[\.)]\s+", stripped) is not None
        is_short_numbered_title = bool(
            is_numbered
            and len(stripped) <= 80
            and re.search(r"(–∫—Ä–∞—Ç–∫|—Ä–∞–∑–±–æ—Ä|–ø—Ä–∏–º–µ—Ä|–∏—Ç–æ–≥|—Ä–µ–∑—é–º–µ|–ø–ª–∞–Ω)", stripped, re.IGNORECASE)
        )

        if is_heading or is_short_numbered_title:
            out.append(f"<b>{html_line}</b>")
            out.append("")  # –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            continue

        # –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
        out.append(html_line)

    # –ü–µ—Ä–µ–≤–æ–¥—ã —Å—Ç—Ä–æ–∫ -> <br>
    html = "\n".join(out)
    html = html.replace("\n\n", "<br><br>").replace("\n", "<br>")

    # –ò—Ç–æ–≥–æ–≤–∞—è —Å–∞–Ω–∞—Ü–∏—è
    return sanitize_telegram_html(html)

