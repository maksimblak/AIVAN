# ‚ö° Retention Notifications - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

## üéØ –ß—Ç–æ —ç—Ç–æ?

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ:
- –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å, –Ω–æ –Ω–µ —Å–¥–µ–ª–∞–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- –ë—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã, –Ω–æ –ø–µ—Ä–µ—Å—Ç–∞–ª–∏ –∑–∞—Ö–æ–¥–∏—Ç—å

## üöÄ –ó–∞–ø—É—Å–∫ (—É–∂–µ –≥–æ—Ç–æ–≤–æ!)

–°–∏—Å—Ç–µ–º–∞ **—É–∂–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞** –≤ –±–æ—Ç–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!

```bash
python src/core/main_simple.py
```

–í –ª–æ–≥–∞—Ö —É–≤–∏–¥–∏—à—å:
```
INFO: ‚úâÔ∏è Retention notifier started
```

–í—Å—ë! –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ.

## üìß –ö–∞–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è?

### 1. –ß–µ—Ä–µ–∑ 24 —á–∞—Å–∞ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
**–ö–æ–º—É:** –ù–∞–∂–∞–ª–∏ /start, –Ω–æ –Ω–µ –∑–∞–¥–∞–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
**–°–æ–æ–±—â–µ–Ω–∏–µ:** –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ 10 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö

### 2. –ß–µ—Ä–µ–∑ 3 –¥–Ω—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
**–ö–æ–º—É:** –ë—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã, –Ω–æ –Ω–µ –∑–∞—Ö–æ–¥–∏–ª–∏ 3 –¥–Ω—è
**–°–æ–æ–±—â–µ–Ω–∏–µ:** –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –±–æ—Ç–∞

### 3. –ß–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
**–ö–æ–º—É:** –ë—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã, –Ω–æ –Ω–µ –∑–∞—Ö–æ–¥–∏–ª–∏ –Ω–µ–¥–µ–ª—é
**–°–æ–æ–±—â–µ–Ω–∏–µ:** –ü–æ—Å–ª–µ–¥–Ω–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ + –Ω–æ–≤—ã–µ —Ñ–∏—á–∏

## üìä –ö–∞–∫ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É?

```python
from src.bot.retention_notifier import retention_notifier

stats = await retention_notifier.get_notification_stats()
print(stats)

# {
#     "total_sent": 1543,
#     "by_scenario": {
#         "registered_no_request": 842,
#         "inactive_3days": 421,
#         "inactive_7days": 280
#     },
#     "blocked_users": 45
# }
```

## üõ† –ö–∞–∫ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é?

```python
from src.bot.retention_notifier import retention_notifier

stats = await retention_notifier.send_manual_notification(
    user_ids=[123456, 789012],
    message="<b>–í–∞–∂–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ!</b>\n\n–¢–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è —Ñ–∏—á–∞...",
    with_buttons=True
)

print(stats)
# {"sent": 1, "failed": 0, "blocked": 1}
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –∑–∞–¥–µ—Ä–∂–∫–∏

–û—Ç–∫—Ä–æ–π `src/bot/retention_notifier.py`:

```python
NOTIFICATION_SCENARIOS = [
    NotificationTemplate(
        name="registered_no_request",
        delay_hours=48,  # –ò–∑–º–µ–Ω–∏ —Å 24 –Ω–∞ 48 —á–∞—Å–æ–≤
        message="...",
        show_buttons=True
    ),
]
```

### –ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

–ü—Ä–æ—Å—Ç–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π `message` –≤ `NOTIFICATION_SCENARIOS`.

### –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π

```python
NOTIFICATION_SCENARIOS.append(
    NotificationTemplate(
        name="inactive_30days",
        delay_hours=720,  # 30 –¥–Ω–µ–π
        message="–°–∫—É—á–∞–µ–º –ø–æ —Ç–µ–±–µ! üò¢",
        show_buttons=True
    )
)
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏

```bash
# –°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏ –±–æ—Ç–∞
grep "Retention" logs/bot.log

# –ü—Ä–∏–º–µ—Ä—ã:
# INFO: RetentionNotifier started
# INFO: Processing 15 users for scenario 'registered_no_request'
# INFO: Sent 14 notifications for scenario 'registered_no_request'
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

```sql
-- –í—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
SELECT * FROM retention_notifications;

-- –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
SELECT * FROM blocked_users;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º
SELECT scenario, COUNT(*) as count
FROM retention_notifications
GROUP BY scenario;
```

## ‚ùì FAQ

### –ö–∞–∫ –æ—Ç–∫–ª—é—á–∏—Ç—å?

–ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –≤ `main_simple.py`:
```python
# retention_notifier = RetentionNotifier(bot, db)
# await retention_notifier.start()
```

### –ü–æ—á–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è?

1. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏: `grep "Retention" logs/bot.log`
2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –ø—Ä–æ—à–ª–æ >= delay_hours —Å –º–æ–º–µ–Ω—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
3. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞

### –ö–∞–∫ —á–∞—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è?

–ö–∞–∂–¥—ã–π —á–∞—Å (3600 —Å–µ–∫—É–Ω–¥). –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ `_notification_loop()`:
```python
await asyncio.sleep(3600)  # –ò–∑–º–µ–Ω–∏ –Ω–∞ –Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

### –°–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∑–∞ —Ä–∞–∑?

–ú–∞–∫—Å–∏–º—É–º 100 –Ω–∞ –∫–∞–∂–¥—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (LIMIT 100 –≤ SQL).

## üêõ –ü—Ä–æ–±–ª–µ–º—ã?

### –¢–µ—Å—Ç—ã
```bash
python test_retention_notifier.py
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤
```bash
python -c "from src.bot.retention_notifier import RetentionNotifier; print('OK')"
```

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **[–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](RETENTION_NOTIFICATIONS.md)** - –≤—Å–µ –¥–µ—Ç–∞–ª–∏
- **[–°–ø–∏—Å–æ–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –±–∞–≥–æ–≤](RETENTION_BUGFIXES.md)** - —á—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

## ‚úÖ Checklist –ø–µ—Ä–µ–¥ production

- [x] –ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω
- [x] –ë–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- [x] –¢–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã (5/5)
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main_simple.py
- [x] –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω—ã

**–í—Å—ë –≥–æ—Ç–æ–≤–æ! üéâ**
