# Retention Notifications Quickstart

Модуль удержания напоминает пользователям о возможностях бота и возвращает их в диалог при падении активности.

## Цели
- Вовремя напоминать о trial квоте и платных подписках.
- Возвращать пользователей, которые перестали задавать вопросы.
- Отслеживать эффективность уведомлений через метрики и логи.

## Быстрый старт
```bash
poetry run python -m src.core.background_tasks --retention
```
Логи появятся с префиксом `retention.notifier`; убедитесь, что сообщения создаются без ошибок.

## Основные сценарии
1. **Welcome follow-up (24 часа)**  
   Отправляется тем, кто активировал бота, но не задал вопрос. Подсвечивает ключевые функции и бесплатный лимит.

2. **Trial reminder (3 дня без активности)**  
   Если trial почти исчерпан или истекает, предлагает оформить подписку.

3. **Churn rescue (7 дней тишины)**  
   Персонализированное сообщение с примером кейса, ссылками на документы и кнопкой «Вернуться в чат».

Все шаблоны находятся в `src/bot/promt.py`. Меняйте тексты через константы `RETENTION_*`.

## Настройка
- Интервалы контролируются в `src/core/background_tasks.py` (см. `RetentionNotifierConfig`).
- В `.env` доступны флаги `ENABLE_RETENTION=1`, `RETENTION_SLEEP_SECONDS`, `RETENTION_DRY_RUN`.
- Для A/B тестов используйте поле `retention_variant` в базе (`db_advanced.py`).

## Мониторинг
- Метрики Prometheus: `retention_notifications_sent_total`, `retention_clicks_total`, `retention_errors_total`.
- Логи с уровнем `INFO`/`WARNING` помогают выявить невалидные chat_id или ограничения Telegram.
- Рекомендуется подключить алерт при росте ошибок отправки.

## Локальное тестирование
1. Запустите Redis/SQLite, чтобы избежать коллизий блокировок.
2. Используйте sandbox-чат или тестового бота без реальных клиентов.
3. Прогоните pytest-сценарии `tests/test_retention_notifier.py`.

